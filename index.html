<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Tracker Kanban Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple scrollbar styling */
        .cards-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .cards-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .cards-container::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        .cards-container::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        /* Styles for new features */
        .task-done .task-name, .task-done .task-notes {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .dragging {
            opacity: 0.5;
            border: 2px dashed #d1d5db;
        }
        .drag-over {
            background-color: #eef2ff; /* indigo-100 */
        }

        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .container {
                margin: 0;
                padding: 0;
                max-width: 100%;
            }
            header button, #loading-indicator, #error-message {
                display: none;
            }
            .cards-container {
                height: auto !important;
                overflow-y: visible !important;
            }
            .bg-white {
                box-shadow: none;
                border: 1px solid #e5e7eb; /* gray-200 */
            }
            #kanban-board {
                display: block; /* Force single column for better print layout */
            }
            #kanban-board > div {
                page-break-inside: avoid;
                margin-bottom: 1.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">ðŸŽ¾ Tennis Channel Project Tracking Board</h1>
            <p class="text-gray-600 mt-2">A live view of project tasks, updated on refresh.</p>
            <button id="export-pdf-btn" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                Export as PDF
            </button>
        </header>

        <!-- Loading and Error States -->
        <div id="loading-indicator" class="text-center py-10">
            <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg font-medium">Fetching latest data...</p>
        </div>
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative text-center" role="alert">
            <strong class="font-bold">Error:</strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <!-- Kanban Board -->
        <div id="kanban-board" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- To Do Column -->
            <div class="bg-white rounded-xl shadow-sm flex flex-col">
                <h2 class="text-lg font-semibold text-gray-700 p-4 border-b border-gray-200 sticky top-0 bg-white rounded-t-xl">To Do</h2>
                <div id="todo-cards" class="p-4 cards-container space-y-4">
                    <!-- Task cards will be inserted here -->
                </div>
            </div>

            <!-- In Progress Column -->
            <div class="bg-white rounded-xl shadow-sm flex flex-col">
                <h2 class="text-lg font-semibold text-gray-700 p-4 border-b border-gray-200 sticky top-0 bg-white rounded-t-xl">In Progress</h2>
                <div id="inprogress-cards" class="p-4 cards-container space-y-4">
                    <!-- Task cards will be inserted here -->
                </div>
            </div>

            <!-- Done Column -->
            <div class="bg-white rounded-xl shadow-sm flex flex-col">
                <h2 class="text-lg font-semibold text-gray-700 p-4 border-b border-gray-200 sticky top-0 bg-white rounded-t-xl">Done</h2>
                <div id="done-cards" class="p-4 cards-container space-y-4">
                    <!-- Task cards will be inserted here -->
                </div>
            </div>

            <!-- Backlog Column -->
            <div class="bg-white rounded-xl shadow-sm flex flex-col">
                <h2 class="text-lg font-semibold text-gray-700 p-4 border-b border-gray-200 sticky top-0 bg-white rounded-t-xl">Backlog</h2>
                <div id="backlog-cards" class="p-4 cards-container space-y-4">
                    <!-- Task cards will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const kanbanBoard = document.getElementById('kanban-board');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            
            const columns = {
                'To Do': document.getElementById('todo-cards'),
                'In progress': document.getElementById('inprogress-cards'),
                'Done': document.getElementById('done-cards'),
                'Backlog': document.getElementById('backlog-cards'),
            };

            // Function to create a single task card
            const createTaskCard = (task) => {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md hover:border-blue-500 transition-shadow duration-200 cursor-grab';
                card.draggable = true;
                card.id = `task-${task['Task ID'] || Math.random().toString(36).substr(2, 9)}`;

                const createdDateStr = task['Created At'];
                let createdDate = 'N/A';
                if (createdDateStr && !isNaN(new Date(createdDateStr))) {
                    createdDate = new Date(createdDateStr).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'short', day: 'numeric'
                    });
                }
                
                // There can be two "Notes" columns, we prefer the second one which is more descriptive.
                // The parser will overwrite the first with the second, which is the desired behavior.
                const taskNotes = task.Notes || 'No notes available.';

                card.innerHTML = `
                    <div class="flex items-start gap-3">
                        <input type="checkbox" class="task-checkbox mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <div class="flex-1">
                            <h3 class="font-semibold text-md mb-2 text-gray-900 task-name">${task.Name || 'Untitled Task'}</h3>
                            <p class="text-sm text-gray-600 mb-3 break-words task-notes">${taskNotes}</p>
                            <div class="border-t border-gray-200 pt-3 flex justify-between items-center text-xs text-gray-500">
                                <span class="font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${task['Owner(s)'] || task['Assignee'] || 'Unassigned'}</span>
                                <span>Created: ${createdDate}</span>
                            </div>
                        </div>
                    </div>
                `;

                // Checkbox strikethrough logic
                const checkbox = card.querySelector('.task-checkbox');
                checkbox.addEventListener('change', () => {
                    card.classList.toggle('task-done', checkbox.checked);
                });

                // Drag and drop event listeners for the card
                card.addEventListener('dragstart', (e) => {
                    card.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', card.id);
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                });

                return card;
            };

            /**
             * Converts CSV text to a JSON array of objects.
             * This parser correctly handles commas inside quoted fields for both headers and data.
             * @param {string} csvText The raw CSV string.
             * @returns {Array<Object>} An array of task objects.
             */
            function csvToJson(csvText) {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return [];

                // Regex to split CSV rows while respecting quotes
                const csvSplitter = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;

                // FIX: Parse headers with the same regex as data rows to handle quoted commas
                const headers = lines[0].trim().split(csvSplitter).map(h => {
                    let header = h.trim();
                    // Remove surrounding quotes from header fields (e.g., "Header with, comma")
                    if (header.startsWith('"') && header.endsWith('"')) {
                        header = header.slice(1, -1).replace(/""/g, '"');
                    }
                    return header;
                });

                const jsonResult = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === '') continue; // Skip empty lines

                    const values = line.split(csvSplitter);

                    // Skip rows where the column count doesn't match the header count
                    if (values.length !== headers.length) {
                        console.warn(`Skipping malformed row ${i + 1}: Column count mismatch. Expected ${headers.length}, found ${values.length}.`, line);
                        continue;
                    }

                    const obj = {};
                    headers.forEach((header, j) => {
                        let value = (values[j] || '').trim(); // Use default empty string
                        // Remove surrounding quotes and un-escape double quotes from data fields
                        if (value.startsWith('"') && value.endsWith('"')) {
                            value = value.slice(1, -1).replace(/""/g, '"');
                        }
                        // If a header is duplicated (like 'Notes'), this will overwrite the previous one.
                        // In Asana exports, the second 'Notes' column is often more useful.
                        obj[header] = value;
                    });
                    jsonResult.push(obj);
                }
                return jsonResult;
            }
            
            const fetchAndDisplayTasks = async () => {
                loadingIndicator.style.display = 'block';
                errorMessage.classList.add('hidden');
                kanbanBoard.classList.add('hidden');
                Object.values(columns).forEach(col => col.innerHTML = '');

                const ASANA_URL = "https://app.asana.com/-/googleSheetsProjectCsv?domain=319271502393035&key=c342a11eb9a76332e0fb53fb124396f9";
                const PROXY_URL = "https://api.allorigins.win/raw?url=";
                const FETCH_URL = PROXY_URL + encodeURIComponent(ASANA_URL);
                
                const MAX_RETRIES = 3;
                for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                    try {
                        const response = await fetch(FETCH_URL, { cache: 'no-cache' });

                        // Check for retryable server errors or timeouts
                        if (!response.ok) {
                            if ((response.status === 408 || response.status === 429 || response.status >= 500) && attempt < MAX_RETRIES - 1) {
                                console.warn(`Request failed with status ${response.status}. Retrying... (Attempt ${attempt + 1})`);
                                const delay = Math.pow(2, attempt) * 1000; // Exponential backoff: 1s, 2s
                                await new Promise(resolve => setTimeout(resolve, delay));
                                continue; // Move to the next attempt
                            }
                            // If it's another error or the last retry, throw to be caught below
                            throw new Error(`Network Error: Status ${response.status}. The proxy or Asana link may be down.`);
                        }
                        
                        const csvText = await response.text();
                        if (!csvText) throw new Error("Received empty data from the source. The Asana link may have expired.");

                        const tasks = csvToJson(csvText);
                        if (!Array.isArray(tasks)) throw new Error('Data format is incorrect after conversion. Expected an array.');
                        
                        if (tasks.length === 0) {
                            throw new Error('No tasks were found. The CSV might be empty or formatted incorrectly.');
                        }

                        tasks.forEach(task => {
                            const section = task['Section/Column'];
                            const targetColumn = columns[section];
                            
                            if (targetColumn) {
                                const card = createTaskCard(task);
                                targetColumn.appendChild(card);
                            } else {
                                console.warn(`Task "${task.Name}" has an unknown section: "${section}", moving to Backlog.`);
                                columns['Backlog'].appendChild(createTaskCard(task));
                            }
                        });

                        kanbanBoard.classList.remove('hidden');
                        loadingIndicator.style.display = 'none';
                        return; // Success, so we exit the function

                    } catch (error) {
                        // This catches fetch errors (e.g., no internet) and the error thrown above
                        if (attempt < MAX_RETRIES - 1) {
                            console.warn(`An error occurred: ${error.message}. Retrying... (Attempt ${attempt + 1})`);
                             const delay = Math.pow(2, attempt) * 1000;
                             await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            // This was the last attempt, so show the final error
                            console.error('Error fetching or processing data after multiple retries:', error);
                            errorText.textContent = `${error.message} This could be a temporary issue. Please try refreshing the page later.`;
                            errorMessage.classList.remove('hidden');
                            loadingIndicator.style.display = 'none';
                        }
                    }
                }
            };

            // Setup drag and drop for columns
            Object.values(columns).forEach(container => {
                container.addEventListener('dragover', e => {
                    e.preventDefault();
                    container.classList.add('drag-over');
                });
                container.addEventListener('dragleave', () => {
                    container.classList.remove('drag-over');
                });
                container.addEventListener('drop', e => {
                    e.preventDefault();
                    container.classList.remove('drag-over');
                    const cardId = e.dataTransfer.getData('text/plain');
                    const draggable = document.getElementById(cardId);
                    if (draggable) {
                        container.appendChild(draggable);
                    }
                });
            });
            
            // PDF export event listener
            exportPdfBtn.addEventListener('click', () => {
                window.print();
            });

            // Initial fetch
            fetchAndDisplayTasks();
            
        });
    </script>

</body>
</html>

